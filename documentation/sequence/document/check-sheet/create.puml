@startuml

' Font configuration
skinparam defaultFontName Times New Roman
skinparam defaultFontSize 15

' Participant styling
skinparam participant {
    BackgroundColor #ECF0F1
    BorderColor #34495E
    FontColor Black
    FontName Times New Roman
    FontSize 15
}

skinparam sequence {
    ArrowColor #34495E
    LifeLineBorderColor #34495E
    LifeLineBackgroundColor #ECF0F1
    ArrowFontName Times New Roman
    ArrowFontSize 15
}

skinparam actorFontSize 15
skinparam noteFontSize 15
skinparam noteFontName "Times New Roman"

' Actors and components
actor "Administrator" as admin #E74C3C
boundary "Create Page" as boundCreate #3498DB
control "Auth\nMiddleware" as authMiddleware #9B59B6
control "Layer\nController" as controller #2ECC71
control "Layer\nService" as service #F39C12
control "Layer\nRepository" as repository #E67E22
control "File\nService" as fileService #16A085
database "Redis Cache" as dbRedis #C0392B
database "PostgreSQL" as dbPsql #2980B9

title
<size:20><b>Sequence Diagram - Create Check Sheet Data</b></size>
----
end title

autonumber


' === MAIN FLOW ===
admin -> boundCreate: Input Check Sheet Data
activate boundCreate

boundCreate -> authMiddleware: POST {endpoint}
activate authMiddleware

' === AUTHENTICATION ===
authMiddleware -> dbRedis: Validate JWT Token
activate dbRedis
dbRedis --> authMiddleware: Token Status
deactivate dbRedis

alt #LightPink Unauthorized (401)
    authMiddleware --> boundCreate: Authentication Failed
    boundCreate --> admin: **Redirect to Login**
    deactivate authMiddleware
    deactivate boundCreate
    else #LightPink Forbidden (403)
        authMiddleware --> boundCreate: Insufficient Permission
        boundCreate --> admin: **Redirect to Forbidden Page**
        deactivate authMiddleware
        deactivate boundCreate
    else #LightGreen Authenticated

    authMiddleware -> controller: Forward Request
    deactivate authMiddleware
    activate controller

    ' === VALIDATION ===
    controller -> controller: Parsing Request
    controller -> service: Process Create Check Sheet
    activate service

    service -> service: Business Validation\n(Duplication, Rules)

    alt #LightPink Validation Failed
        service --> controller: 422 Validation Error
        controller --> boundCreate: Error Response
        boundCreate --> admin: **Show Validation Error**
        deactivate service
        deactivate controller
        deactivate boundCreate

    else #LightGreen Validation Success



        ' === SAVE TO DATABASE ===
        service -> repository: Save Check Sheet
        activate repository

        repository -> dbPsql: Store Check Sheet Data
        activate dbPsql

        alt #LightPink Database Error
            dbPsql --> repository: SQLException
            deactivate dbPsql
            repository --> service: Database Error
            deactivate repository



            service --> controller: 500 Internal Server Error
            controller --> boundCreate: Error Response
            boundCreate --> admin: **Show Error Message**
            deactivate service
            deactivate controller
            deactivate boundCreate

        else #LightGreen Success
            dbPsql --> repository: Success
            deactivate dbPsql

             service -> service: Record Audit Log
                    service -> repository: Find All Data
                    activate repository

                    repository -> dbPsql: Query Check Sheet Data\n(Pagination, Filter, Sort)
                    activate dbPsql
                    dbPsql --> repository: Data Result
deactivate dbPsql

                  repository --> service: Return Check Sheet List
                    deactivate repository

                    deactivate dbPsql
                    service --> controller: Return Data List

                    deactivate service
                        controller --> boundCreate: 200 OK + Data
                    deactivate controller
                    boundCreate --> admin: **Display Check Sheet List**
                    deactivate boundCreate

                end
    end
end

@enduml