@startuml

' Font configuration
skinparam defaultFontName Times New Roman
skinparam defaultFontSize 15

' Participant styling
skinparam participant {
    BackgroundColor #ECF0F1
    BorderColor #34495E
    FontColor Black
    FontName Times New Roman
    FontSize 15
}

skinparam sequence {
    ArrowColor #34495E
    LifeLineBorderColor #34495E
    LifeLineBackgroundColor #ECF0F1
    ArrowFontName Times New Roman
    ArrowFontSize 15
}

skinparam actorFontSize 15
skinparam noteFontSize 15
skinparam noteFontName "Times New Roman"

' Actors and components
actor "Administrator" as admin #E74C3C
boundary "Dashboard\nPage" as boundDashboard #3498DB
boundary "Facility\nPage" as boundFacility #3498DB
boundary "Machine\nPage" as boundMachine #3498DB
control "Auth\nMiddleware" as authMiddleware #9B59B6
control "Register\nController" as controller #2ECC71
control "Register\nService" as service #F39C12
control "Modbus\nService" as modbusService #16A085
database "Redis Cache" as dbRedis #C0392B
database "PostgreSQL" as dbPsql #2980B9
database "Modbus Server" as modbusServer #7F8C8D

title
<size:20><b>Sequence Diagram - View and Update Register Value</b></size>
----
end title

autonumber

' === ACCESS DASHBOARD ===
admin -> boundDashboard: Access Dashboard
activate boundDashboard

alt Executive Mode
    admin -> boundDashboard: Click Pinpoint Area
    boundDashboard --> admin: Redirect Into Facility Overview
    admin -> boundFacility: Select Machine
    boundDashboard --> admin: Redirect Into Machine Overview
admin -> boundMachine: Click Register Panel

else Machine Mode
    admin -> boundDashboard: Select Machine Directly
admin -> boundDashboard: Click Register Panel

end


' === VIEW REGISTER PANEL ===
boundDashboard --> admin: Show Manage Dialog Register Value

' === UPDATE REGISTER VALUE ===
admin -> boundDashboard: Input  Value\n& Click Send

boundDashboard -> authMiddleware: PUT /registers/value/{id}
activate authMiddleware

authMiddleware -> dbRedis: Validate JWT Token
activate dbRedis
dbRedis --> authMiddleware: Token Status
deactivate dbRedis

alt #LightPink Unauthorized (401)
    authMiddleware --> boundDashboard: Authentication Failed
    boundDashboard --> admin: **Redirect to Login**
    deactivate authMiddleware
    deactivate boundDashboard

else #LightPink Forbidden (403)
    authMiddleware --> boundDashboard: Insufficient Permission
    boundDashboard --> admin: **Show 403 Forbidden Page**
    deactivate authMiddleware
    deactivate boundDashboard

else #LightGreen Authenticated

    authMiddleware -> controller: Forward Request
    deactivate authMiddleware
    activate controller

    controller -> controller: Validate Request

    controller -> service: Process Update Value
    activate service

    service -> service: Business Validation\n(Data Type, Range, Rules)

    alt #LightPink Validation Failed
        service --> controller: 422 Validation Error
        controller --> boundDashboard: Error Response
        boundDashboard --> admin: **Show Validation Error**

    else #LightGreen Validation Success





            ' === SEND TO MODBUS SERVER ===
            service -> modbusService: Write Register Value
            activate modbusService

            modbusService -> modbusServer: Send Command\n(Write Register)
            activate modbusServer

            alt #LightPink Modbus Error
                modbusServer --> modbusService: Connection/Write Error
                deactivate modbusServer
                modbusService --> service: Modbus Exception
                deactivate modbusService
                service --> controller: 500 Internal Server Error
                controller --> boundDashboard: Error Response
                boundDashboard --> admin: **Show Modbus Error**

            else #LightGreen Modbus Success
                modbusServer --> modbusService: Success
                deactivate modbusServer

                modbusService --> service: Value Written
                deactivate modbusService

                service --> controller: Success Response
                deactivate service

                controller --> boundDashboard: 200 OK
                deactivate controller

                boundDashboard --> admin: **Show Success Message**
                deactivate boundDashboard
            end
        end
end
@enduml