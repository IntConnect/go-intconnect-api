@startuml

' Font configuration
skinparam defaultFontName Times New Roman
skinparam defaultFontSize 15

' Participant styling
skinparam participant {
    BackgroundColor #ECF0F1
    BorderColor #34495E
    FontColor Black
    FontName Times New Roman
    FontSize 15
}

skinparam sequence {
    ArrowColor #34495E
    LifeLineBorderColor #34495E
    LifeLineBackgroundColor #ECF0F1
    ArrowFontName Times New Roman
    ArrowFontSize 15
}

skinparam actorFontSize 15
skinparam noteFontSize 15
skinparam noteFontName "Times New Roman"

' Actors and components
actor "Administrator" as admin #E74C3C
boundary "List Data\nPage" as boundListData #3498DB
control "Auth\nMiddleware" as authMiddleware #9B59B6
control "Layer\nController" as controller #2ECC71
control "Layer\nService" as service #F39C12
control "Layer\nRepository" as repository #F39C12
control "File\nService" as fileService #16A085
database "Redis Cache" as dbRedis #C0392B
database "PostgreSQL" as dbPsql #2980B9
database "Local Storage" as localStorage #7F8C8D

title
<size:20><b>Sequence Diagram - Delete Configuration Data</b></size>
<size:14>(MQTT Broker, MQTT Topic, SMTP Server, Modbus Server)</size>
----
end title

autonumber

note over admin, localStorage
    **Placeholder Mapping:**

    <b><resource></b> = mqtt-broker | mqtt-topic | smtp-server | modbus-server
    <b>{endpoint}</b> = /mqtt-brokers | /mqtt-topics | /smtp-servers | /modbus-servers
end note

' === FETCH EXISTING DATA ===
admin -> boundListData: Click Trash Button
note over admin, boundListData
Tombol dengan Icon Trash
end note
activate boundListData

boundListData -> authMiddleware: POST {endpoint}
activate authMiddleware

authMiddleware -> dbRedis: Validate JWT Token
activate dbRedis
dbRedis --> authMiddleware: Token Status
deactivate dbRedis

alt #LightPink Unauthorized (401)
    authMiddleware --> boundListData: Authentication Failed
    boundListData --> admin: **Redirect to Login**
    deactivate authMiddleware
    deactivate boundListData
else #LightPink Forbidden (403)
    authMiddleware --> boundListData: Insufficient Permission
    boundListData --> admin: **Redirect to Forbidden Page**
    deactivate authMiddleware
    deactivate boundListData
else #LightGreen Authenticated

    authMiddleware -> controller: Forward Request
    deactivate authMiddleware
    activate controller

    controller -> controller: Parsing Id and Request
    controller -> service: Delete <resource>
    activate service

service -> service: Validate Request
    service -> repository: Query Existing Data
    repository -> dbPsql: Find By Id
    activate dbPsql

    alt #LightPink Data Not Found
        dbPsql --> service: No Data
        deactivate dbPsql
        service --> controller: 404 Not Found
        controller --> boundListData: Error Response
        boundListData --> admin: **Show Error Message**
        deactivate service
        deactivate controller
        deactivate boundListData

    else #LightGreen Data Found
        dbPsql --> service: Existing Data
        opt  File Exists
                        service -> localStorage: Move File into Trash Folder
        localStorage --> service: Return New Path
        service -> service: Update File Path
        end

        service -> repository: Delete By Id
        repository -> dbPsql: Update deleted_at
        service -> repository: Query Data
        repository -> dbPsql: Find Data with Pagination
        repository --> service: Parsing Into Model
        deactivate dbPsql

        service --> controller: Parsing Into Response
        deactivate service

        controller --> boundListData: Return Data
        deactivate controller

        boundListData --> admin: Show Success Message
        boundListData --> admin: Render Data


    end
end

@enduml